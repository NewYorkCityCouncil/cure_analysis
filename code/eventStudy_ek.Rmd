---
title: "eventStudy_ek"
author: "Eric Koepcke"
date: "2023-07-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../code/00_load_dependencies.R")
library(forcats)
library(sandwich)
library(lmtest)
library(stargazer)
library(MASS)
library(AER)
library(zoo)
library(ggiraph)
library(htmlwidgets)
if (Sys.getenv("HOME")=="/Users/ekoepcke") {
  figPth <- "/Users/ekoepcke/Desktop/DataTeam/Projects/CureViolence/cure_analysis/paper/figuresTables" 
}
```

```{r}
# Read in all data used
# Shootings
shootings_historical <-
 #read.csv("../data/input/NYPD_Shooting_Incident_Data__Historic_-2.csv")
  fread("https://data.cityofnewyork.us/resource/833y-fsy8.csv?$limit=9999999999999999") %>% clean_names()

shootings_ytd <- 
  #read.csv("../data/input/NYPD_Shooting_Incident_Data__Year_To_Date_-2.csv")
  fread("https://data.cityofnewyork.us/resource/5ucz-vwe8.csv?$limit=9999999999999") %>% clean_names()

# Population by precinct
precinct_pop <- read.csv("../data/input/nyc_2010pop_2020precincts.csv") %>% clean_names()

# Program dates
program_dates <- read_excel("../data/input/CMS\ List\ 1.6.22\ for\ NYCC\ .xlsx") %>% clean_names()
```

```{r}
##########################################
#Shootings data exploration, cleaning
##########################################

#Gives dimensions, variables names/types, and first several values
glimpse(shootings_ytd)
glimpse(shootings_historical)

#Use mutate for variable creation, modification, and deletion. Used here to convert var type
shootings_ytd <- (shootings_ytd %>% 
                     mutate(statistical_murder_flag = ifelse(statistical_murder_flag=="Y", TRUE, FALSE)))

#append datasets
shootings <- bind_rows(shootings_ytd, shootings_historical)
#delete objects
rm(shootings_ytd, shootings_historical)

#Changes date column into three variables
shootings <- (shootings %>% 
  separate(occur_date, c("year","month","day"), sep="-", remove=FALSE) %>% 
    mutate(year = as.integer(year), month = as.integer(month), day = as.integer(day)))

#indicator for rows that came from YTD file
shootings <- (shootings %>% mutate(fromYTD = (year==2023)))

#sort
shootings <- (shootings %>% arrange(year, month, day))

#number of missing values by variable
colSums(is.na(shootings))

#There's no duplicates based on all variables
n_distinct(shootings)
#incident keys are not unique though
n_distinct(shootings$incident_key)
#isolate the duplicates
temp <- (shootings %>% 
           mutate(dupKey = (duplicated(incident_key) | duplicated(incident_key, fromLast = TRUE))) %>%
           filter(dupKey==TRUE) %>% 
           arrange(incident_key))
#Looks like duplicates do pertain to a particular incident, the duplicates perhaps 
#indicate multiple perps or multiple victims (multiple victims according to data notes)

shootings %>% count(year)
shootings %>% count(month)

shootings %>% count(boro)

#lot of missing values---before 2022 don't have inside/outside indicator
table(shootings$year, shootings$loc_of_occur_desc, useNA = 'ifany')

n_distinct(shootings$precinct)

shootings %>% count(jurisdiction_code)
table(shootings$loc_classfctn_desc, shootings$jurisdiction_code, useNA = 'ifany')

#missing before 2022
shootings %>% count(loc_classfctn_desc)

#A lot missing in each year
shootings %>% count(location_desc)

shootings %>% count(statistical_murder_flag)

#a lot of missing values
shootings %>% count(perp_age_group)
shootings %>% count(perp_sex)
shootings %>% count(perp_race)
shootings %>% count(vic_age_group)
shootings %>% count(vic_sex)
shootings %>% count(vic_race)

sum(is.na(shootings$latitude))
sum(is.na(shootings$longitude))
sum(substr(shootings$geocoded_column, start=1, stop=5)!='POINT')

#convert missing values to NA
shootings <- shootings %>% 
  mutate(loc_of_occur_desc = ifelse(loc_of_occur_desc=="", NA, loc_of_occur_desc),
         loc_classfctn_desc = ifelse(loc_classfctn_desc %in% c("", "(null)"), NA, loc_classfctn_desc),
         location_desc = ifelse(location_desc %in% c("NONE", "(null)", ""), NA, location_desc),
         perp_age_group = ifelse(perp_age_group %in% 
                                   c("", "(null)", "1020", "1028", "224", "940", "UNKNOWN"), 
                                 NA, perp_age_group),
         perp_sex = ifelse(perp_sex %in% c("", "(null)", "U"), NA, perp_sex),
         perp_race = ifelse(perp_race %in% c("", "(null)", "UNKNOWN"), NA, perp_race),
         vic_age_group = ifelse(vic_age_group %in% c("1022", "UNKNOWN"), 
                                 NA, vic_age_group),
         vic_sex = ifelse(vic_sex=="U", NA, vic_sex),
         vic_race = ifelse(vic_race=="UNKNOWN", NA, vic_race),
         geocoded_column = ifelse(geocoded_column=="", NA, geocoded_column)) 

#Change var types, setting to null deletes a var,
shootings <- shootings %>% mutate(boro = as.factor(boro),
                             loc_of_occur_desc = as.factor(loc_of_occur_desc),
                             jurisdiction_code = as.factor(jurisdiction_code),
                             loc_classfctn_desc = as.factor(loc_classfctn_desc),
                             location_desc = as.factor(location_desc),
                             perp_age_group = as.factor(perp_age_group),
                             perp_sex = as.factor(perp_sex),
                             perp_race = as.factor(perp_race),
                             vic_age_group = as.factor(vic_age_group),
                             vic_sex = as.factor(vic_sex),
                             vic_race = as.factor(vic_race)
                             )

#create year-month, year-quarter variables
shootings <- shootings %>% mutate(yr_month = as.yearmon(paste(year, month), format="%Y %m"))
shootings <- shootings %>% mutate(yr_qtr = as.yearqtr(paste(year, month), format="%Y %m"))

#Collapse data
#Can come back and collapse at month level. Also make distinction between fatal/non-fatal shootings
shootings_yr <- shootings %>% group_by(year, precinct) %>% 
  summarise(boro = first(boro), numShootings = n(),
            numLethal = sum(statistical_murder_flag)) %>% ungroup()
shootings_yr <- shootings_yr %>% mutate(numNonlethal = numShootings-numLethal)

#There should be 77 police precincts
n_distinct(shootings_yr$precinct)
#Not every precinct has a shooting in every year
shootings_yr %>% group_by(year) %>% summarise(n = n_distinct(precinct))
#Fill in missing year-precincts, i.e., create balanced panel
shootings_yr <- shootings_yr %>% complete(year,precinct)
shootings_yr <- shootings_yr %>% arrange(precinct, year)
#replace NAs with appropriate values
shootings_yr <- shootings_yr %>% mutate(numShootings = ifelse(is.na(numShootings), 0, numShootings),
                                        numLethal = ifelse(is.na(numLethal), 0, numLethal),
                                        numNonlethal = ifelse(is.na(numNonlethal), 0, numNonlethal))
shootings_yr <- shootings_yr %>% group_by(precinct) %>% fill(boro, .direction="updown") %>% ungroup()

```

```{r}
################################ 
#Setup data for analysis
################################

########
#Merge in CURE program data

#Precincts 40,44,67,73,75,114 have multiple rows. In each, it's appropriate to keep the
#first/earliest row (except for precinct 67)---this keeps the (earliest) fully operational Cure program
program_dates %>% count(precinct)
program_dates <- program_dates %>% filter(!(precinct==67 & date_text=='22-Jan'))
program_dates <- program_dates %>% filter(duplicated(precinct)==FALSE)

# Separate and filter program dates
program_dates <- program_dates %>% 
  separate(date_text, c("yearCure","monthCure"),remove=FALSE) %>%
  mutate(yearCure = as.numeric(paste(20,yearCure,sep="")),
         monthCure = match(monthCure, c('Jan', 'Feb', 'Mar', 'April', 'May', 'June', 
                                        'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'))) %>% 
  mutate(wavesCure=2022-yearCure)

programMerge <- program_dates %>% 
  dplyr::select(precinct, yearCure, monthCure, wavesCure)

#merge in program info
shootings_cure <- shootings_yr %>% left_join(programMerge, by=join_by(precinct))
shootings_cure <- shootings_cure %>% arrange(precinct,year)

#Don't have full year of shootings data for 2023, so drop that year
shootings_cure <- shootings_cure %>% filter(year<2023)

#Drop precinct 22---it's Central Park, only saw one shooting there in data
shootings_cure <- shootings_cure %>% filter(precinct!=22)

#Flag Cure precincts
shootings_cure <- shootings_cure %>% mutate(curePrecinct = !is.na(yearCure))

#Flag 2019 and earlier Cure precincts, want to study dynamic effects
shootings_cure <- shootings_cure %>% 
  mutate(curePre2020 = (curePrecinct & yearCure < 2020))

#Flag early, mid, late adopters to explore spillover effects
shootings_cure <- shootings_cure %>% 
  mutate(earlyCure = (curePrecinct & yearCure < 2015),
         midCure = (curePrecinct & yearCure %in% c(2015, 2016)),
         lateCure = (curePrecinct & yearCure == 2019))
        
#Flag whether Cure is "on" or not
shootings_cure <- shootings_cure %>% 
  mutate(cureOn = (curePrecinct & year>=yearCure))

#Flag control precincts that are touching Cure precincts and, thus,
#may be affected by spillovers and might not be appropriate controls
shootings_cure <- shootings_cure %>% 
  mutate(controlSO = (precinct %in% c(19,26,28,30,33,41,45,49,50,61,62,63,66,72,78,83,
                                      84,90,100,102,104,106,107,108,111,115,121,122)))

#To explore spillovers, for each precinct that's touching a Cure 
#precinct (not including itself), create "spillover treatment" date set to the
#earliest yearCure for any Cure precinct touching it
shootings_cure <- shootings_cure %>% 
  mutate(yearSO = ifelse(precinct %in% c(67,69,71,73,78,79,81,83,88,102,104,106), 2012, NA)) %>%
  mutate(yearSO = ifelse(precinct %in% c(41,42,44,103,105), 2013, yearSO)) %>% 
  mutate(yearSO = ifelse(precinct %in% c(121,122), 2014, yearSO)) %>%
  mutate(yearSO = ifelse(precinct %in% c(40,43,46,48,52,75,77,90,100), 2015, yearSO)) %>%
  mutate(yearSO = ifelse(precinct %in% c(19,25,26,28,30,33,45,49,50,61,62,108,115), 2016, yearSO)) %>%
  mutate(yearSO = ifelse(precinct %in% c(23,32,47,84), 2019, yearSO)) %>%
  mutate(yearSO = ifelse(precinct %in% c(63,66,70,72,107,111,113), 2021, yearSO))

#Flag whether "spillover treatment" is "on" or not
shootings_cure <- shootings_cure %>% 
  mutate(spilloverOn = (!is.na(yearSO) & year>=yearSO))

#RUN this line if want to use min(yearCure, yearSO) as the ``treatment date''
# shootings_cure <- shootings_cure %>%
#   mutate(yearCure = ifelse(curePrecinct & !is.na(yearSO) & yearSO<yearCure, yearSO, yearCure))

#Create event-time variables
shootings_cure <- shootings_cure %>% 
  mutate(year_offset = year-yearCure,
         year_offsetSO = year-yearSO)
shootings_cure %>% count(year_offset)
shootings_cure %>% count(year_offsetSO)

shootings_cure <- shootings_cure %>% 
  mutate(yrPostCure = ifelse(is.na(year_offset) | year_offset<0, 0, year_offset))
shootings_cure <- shootings_cure %>% 
  mutate(yrPostSO = ifelse(is.na(year_offsetSO) | year_offsetSO<0, 0, year_offsetSO))
shootings_cure %>% count(yrPostSO)

#Create indicators for event study regressions
#lb is the lower bound for lags
#ub is the upper bound for leads
#must have lb < 0, ub > 0
genIndicators <- function(lb, ub) {
  temp <- shootings_cure
  for (i in lb:ub) {
    if (i <= 0) {
      j <- i*-1
      newVar <- paste0('lag',j)
    } else {
      newVar <- paste0('lead',i)
    }

    #for lb "accumulate" lags before it, for ub "accumlate" the leads above it
    if (i > lb & i < ub) {
      temp <- temp %>% 
        mutate(!!sym(newVar) := (!is.na(year_offset) & year_offset==i))
    } else if (i==lb) {
      temp <- temp %>% 
        mutate(!!sym(newVar) := (!is.na(year_offset) & year_offset<=lb))
        
    } else {
      temp <- temp %>% 
        mutate(!!sym(newVar) := (!is.na(year_offset) & year_offset>=ub))
    }
  }
  return(temp)
}
#similar function for "spillover treatment" lags/leads
genIndicatorsSO <- function(lb, ub) {
  temp <- shootings_cure
  for (i in lb:ub) {
    if (i <= 0) {
      j <- i*-1
      newVarSO <- paste0('lagSO',j)
    } else {
      newVarSO <- paste0('leadSO',i)
    }

    #for lb "accumulate" lags before it, for ub "accumlate" the leads above it
    if (i > lb & i < ub) {
      temp <- temp %>% 
        mutate(!!sym(newVarSO) := (!is.na(year_offsetSO) & year_offsetSO==i))
    } else if (i==lb) {
      temp <- temp %>% 
        mutate(!!sym(newVarSO) := (!is.na(year_offsetSO) & year_offsetSO<=lb))
        
    } else {
      temp <- temp %>% 
        mutate(!!sym(newVarSO) := (!is.na(year_offsetSO) & year_offsetSO>=ub))
    }
  }
  return(temp)
}
#Can play around here with how many lags/leads to include
shootings_cure <- genIndicators(-6, 3)
shootings_cure <- genIndicatorsSO(-6, 3)

#merge in population data
popMerge <- precinct_pop %>% dplyr::select(precinct_2020, p0010001) %>% 
  rename(precinct=precinct_2020,pop=p0010001)
shootings_cure <- shootings_cure %>% left_join(popMerge, by=join_by(precinct))

#Create shootings per 10,000 people var
shootings_cure <- shootings_cure %>% mutate(numShootingsPP = (numShootings/pop)*10000)
summary(shootings_cure$numShootingsPP)

#Create ratio of num shootings to average num shootings in 2006-2011, by precinct
shootings_cure <- shootings_cure %>% group_by(precinct) %>% 
  mutate(avgPreLvl = mean(numShootings[1:6])) %>% ungroup()
shootings_cure <- shootings_cure %>% 
  mutate(numShootingsRatio = ifelse(avgPreLvl>0,numShootings/avgPreLvl,NA))
summary(shootings_cure$numShootingsRatio)

########
#SUBSET THE DATA HERE HOW YOU WANT IT FOR THE ANALYSIS
########
#Including all precincts
# df_analysis <- shootings_cure
#Exclude post-2019 Cure precincts
df_analysis <- shootings_cure %>% filter(!curePrecinct | curePre2020)
#Only pure control and 2012-2014 cure precincts
# df_analysis <- shootings_cure %>% filter(!curePrecinct | earlyCure)
#Only pure control and 2015-2016 cure precincts
# df_analysis <- shootings_cure %>% filter(!curePrecinct | midCure)
#Only pure control and 2019 cure precincts
# df_analysis <- shootings_cure %>% filter(!curePrecinct | lateCure)
#Only pure control and pre-2019 cure precincts
# df_analysis <- shootings_cure %>% filter(!curePrecinct | earlyCure | midCure)
#Only pure control and post-2014 cure precincts
# df_analysis <- shootings_cure %>% filter(!curePrecinct | midCure | lateCure)
#Only pure control and 2021 cure precincts
# df_analysis <- shootings_cure %>% filter(!curePrecinct | !curePre2020)
#Only include pre-2020 Cure precincts
# df_analysis <- shootings_cure %>% filter(curePre2020)
#Only non-touching pure controls and pre-2020 Cure
# df_analysis <- shootings_cure %>% filter((!curePrecinct & !controlSO) | curePre2020)
#Only control units
# df_analysis <- shootings_cure %>% filter(!curePrecinct)
#Exclude cure precincts with yearSO>=yearCure
# df_analysis <- shootings_cure %>%
#   filter(!curePrecinct | (curePre2020 & !is.na(yearSO) & yearSO<yearCure))
#Exclude cure precincts with yearSO>=yearCure and touching control units
# df_analysis <- shootings_cure %>%
#   filter((!curePrecinct & !controlSO)  | (curePre2020 & !is.na(yearSO) & yearSO<yearCure))
#Exclude cure precincts with yearSO<=yearCure and touching control units
# df_analysis <- shootings_cure %>%
#   filter((!curePrecinct & !controlSO)  | (curePre2020 & !is.na(yearSO) & yearSO>yearCure))
#Only nontouching controls and non-SO Cure units
# df_analysis <- shootings_cure %>%
#   filter((!curePrecinct & !controlSO) | (curePre2020 & is.na(yearSO)))
```

```{r}
#event study regression
#Need to change code based on how many lags/leads you're using
#Can choose here which period to use as the leave-out/reference period, most common
#choice is lag1. Can also use multiple reference periods.
#Can also exclude post-2019 Cure precincts from control group
#Can also look at impact on lethal/non-lethal shootings, shootingsPP
model <- glm(numShootings ~ factor(precinct) + factor(year) + lag6 + lag5 + lag4 +
              lag3 + lag2 + lag0 + lead1 + lead2 + lead3, data=df_analysis, family='poisson')
dispersiontest(model,trafo=1)
model <- lm(numShootings ~ factor(precinct) + factor(year) + lag6 + lag5 + lag4 +
              lag3 + lag2 + lag0 + lead1 + lead2 + lead3, data=df_analysis)
# model <- lm(numShootings ~ factor(precinct) + factor(year) + lagSO6 + lagSO5 + lagSO4 +
#               lagSO3 + lagSO2 + lagSO0 + leadSO1 + leadSO2 + leadSO3, data=df_analysis)
model <- glm(numShootings ~ factor(precinct) + factor(year) + lagSO6 + lagSO5 + lagSO4 +
               lagSO3 + lagSO2 + lagSO0 + leadSO1 + leadSO2 + leadSO3, data=df_analysis, family='poisson')
summary(model)

#check for heteroskedasticity
plot(fitted(model), resid(model))
bptest(model)

#robust SEs
coeftest(model, vcov=vcovHC(model, type='HC1'))
robust_se <- sqrt(diag(vcovHC(model, type = "HC1")))
robust_se <- tail(robust_se,9)

#Cluster SEs at the precinct level
# robust_se <- vcovCL(model, cluster=df_analysis$precinct)
# robust_tests <- coeftest(model, vcov.=robust_se)
# print(robust_tests)

#get coefficients/std errors for lags/leads
coefs <- coef(summary(model))
coefs <- tail(coefs, 9)
coefs[, "Std. Error"] <- robust_se
coef_df <- data.frame(
  variable = rownames(coefs),
  estimate = exp(coefs[, "Estimate"])-1,
  lowerCI = exp(coefs[, "Estimate"] - 1.96*coefs[, "Std. Error"])-1,
  upperCI = exp(coefs[, "Estimate"] + 1.96*coefs[, "Std. Error"])-1
)

#add row for leave-out/reference period
coef_df <- rbind(coef_df, c('lag1TRUE', 0, 0, 0))
# coef_df <- rbind(coef_df, c('lagSO1TRUE', 0, 0, 0))
coef_df <- coef_df %>% mutate(estimate=as.numeric(estimate),
                              lowerCI=as.numeric(lowerCI),
                              upperCI=as.numeric(upperCI))

#do below to plot coefficients in the right order
coef_df <- coef_df %>%
  mutate(variable = fct_relevel(variable, 'lag6TRUE','lag5TRUE','lag4TRUE','lag3TRUE',
                                'lag2TRUE', 'lag1TRUE', 'lag0TRUE','lead1TRUE',
                                'lead2TRUE','lead3TRUE'))
# coef_df <- coef_df %>%
#   mutate(variable = fct_relevel(variable, 'lagSO6TRUE','lagSO5TRUE','lagSO4TRUE','lagSO3TRUE',
#                                 'lagSO2TRUE', 'lagSO1TRUE', 'lagSO0TRUE','leadSO1TRUE',
#                                 'leadSO2TRUE','leadSO3TRUE'))

#Plot coefficients with 95% CIs
xlabs <- c('<= -6','-5','-4','-3','-2','-1','0','1','2','>= 3')
plt <- ggplot(data = coef_df, aes(x=variable, y=estimate, group=1)) +
  geom_point_interactive(aes(tooltip=paste0(round(estimate*100,digits=1),"%")),size=3) +
  geom_line()+
  geom_errorbar(aes(ymin=lowerCI,ymax=upperCI), width=0.2, color='blue') +
  geom_hline(yintercept=0, color='black', alpha=0.5) +
  geom_vline(xintercept = 7, linetype='dashed', color='black',alpha=0.5) +
  labs(x="Years since Cure Implementation", y="Change in Shootings") +
  scale_x_discrete(labels=xlabs)+
  scale_y_continuous(labels = percent_format())+
  theme(plot.title = element_text(size=16, face='bold',hjust=0.5))
  theme_minimal()
saveWidget(girafe(ggobj=plt),file.path(figPth,"mainPoisES.html"))
#ggsave(file.path(figPth,"SOafterCureES.pdf"), plt, width=5, height=4, units="in")

stargazer(model, type='latex', style='aer', out=file.path(figPth,"mainESTab.tex"),
          covariate.labels=c('<=6 years pre-Cure','5 years pre-Cure','4 years pre-Cure',
                             '3 years pre-Cure','2 years pre-Cure','Cure start year',
                             '1 year post-Cure','2 years post-Cure','>=3 years post-Cure'),
          dep.var.labels=c('Num. of Shootings'), align=TRUE, df=FALSE, header=FALSE,
          keep=c(85:93), keep.stat=c('n'), no.space=TRUE, notes=NULL, omit.table.layout='n')

#Single indicator model
model1 <- lm(numShootings ~ factor(precinct) + factor(year) + cureOn, data=df_analysis)
summary(model1)
model1 <- glm(numShootings ~ factor(precinct) + factor(year) + cureOn, data=df_analysis, family='poisson')
# model1 <- glm(numShootings ~ factor(precinct) + factor(year) + spilloverOn, data=df_analysis, family='poisson')
summary(model1)
coeftest(model1, vcov=vcovHC(model1, type='HC1'))

#Model with linear dynamic treatment effects
model2 <- lm(numShootings ~ factor(precinct) + factor(year) + cureOn +
              yrPostCure, data=df_analysis)
summary(model2)
model2 <- glm(numShootings ~ factor(precinct) + factor(year) + cureOn +
              yrPostCure, data=df_analysis, family='poisson')
# model2 <- glm(numShootings ~ factor(precinct) + factor(year) + spilloverOn + yrPostSO, data=df_analysis, family='poisson')
summary(model2)
coeftest(model2, vcov=vcovHC(model2, type='HC1'))

#model with quadratic dynamic treatment effects
model3 <- lm(numShootings ~ factor(precinct) + factor(year) + cureOn +
              yrPostCure + I(yrPostCure^2), data=df_analysis)
summary(model3)
model3 <- glm(numShootings ~ factor(precinct) + factor(year) + cureOn +
              yrPostCure + I(yrPostCure^2), data=df_analysis, family='poisson')
# model3 <- glm(numShootings ~ factor(precinct) + factor(year) + spilloverOn + yrPostSO + I(yrPostSO^2), data=df_analysis, family='poisson')
summary(model3)
coeftest(model3, vcov=vcovHC(model3, type='HC1'))

stargazer(list(model1,model2,model3), type='latex', style='aer', out=file.path(figPth,"nonESRegTab.tex"),
          covariate.labels=c('Cure Implemented', 'Num. Years of Cure', 'Num. Years of Cure Sq.'),
          dep.var.labels=c('Num. of Shootings'), align=TRUE, df=FALSE, header=FALSE,
          keep=c(85:88), keep.stat=c('n'), no.space=TRUE, notes=NULL, omit.table.layout='n')
```

```{r}
#plotting

#histogram
shootings %>% filter(year < 2023) %>% ggplot(aes(x=year)) + geom_histogram(binwidth=1, color="white", fill="blue")
shootings %>% filter(year < 2023 & statistical_murder_flag==TRUE) %>% ggplot(aes(x=year)) + geom_histogram(binwidth=1, color="white", fill="blue")
shootings %>% filter(year < 2023 & statistical_murder_flag==FALSE) %>% ggplot(aes(x=year)) + geom_histogram(binwidth=1, color="white", fill="blue")

shootings %>% ggplot(aes(x=yr_month)) + geom_histogram(bins=207, color="white", fill="blue")

summary(shootings_yr$numShootings)
shootings_yr %>% ggplot(aes(x=numShootings)) + geom_histogram(binwidth = 1, color="white", fill="blue")

#Plot histogram of Cure implementation years
temp <- shootings_cure %>% filter(curePrecinct) %>% group_by(precinct) %>%
  summarise(yearCure = first(yearCure))
plt <- ggplot(data=temp, aes(x=yearCure)) + 
  geom_histogram(binwidth=1, color='white', fill='blue') +
  xlim(2010,2023)+
  labs(x='Year', y='Number of Precincts')+
  #theme(plot.title = element_text(size=16, face='bold',hjust=0.5))
  theme_minimal()
ggsave(file.path(figPth,"cureDateHist.pdf"), plt, width=5, height=3, units="in")
  
#Plot average number of shootings (precinct level) by year for cure and non-cure precincts
temp <- df_analysis %>% group_by(curePrecinct, year) %>% summarise(numShootings = mean(numShootings))
plt <- ggplot(data=temp, aes(x=year, y=numShootings, color=curePrecinct)) +
  geom_point_interactive(aes(tooltip=round(numShootings,digits=0)), size=2) +
  geom_line() +
  ylim(0,70)+
  labs(x="Year", y="Number of Shootings",
       color="") +
  scale_color_manual(values=c('red','blue'),labels=c("Control", 'Cure'))+
  theme(legend.position='bottom', plot.title = element_text(size=16, face='bold',hjust=0.5))
  theme_minimal()
saveWidget(girafe(ggobj=plt),file.path(figPth,"numShootings_byCure.html"))
ggsave(file.path(figPth,"numShootings_byCure.pdf"), plt, width=5, height=4, units="in")

#Plot average number of shootings (precinct level) by year for cure and post-2019 cure precincts
temp <- shootings_cure %>% filter(curePrecinct) %>% group_by(curePre2020, year) %>% summarise(numShootings = mean(numShootings))
ggplot(data=temp, aes(x=year, y=numShootings, color=curePre2020)) +
  geom_point(size=2) +
  geom_line()+
  ylim(0,70)+
  labs(x="Year", y="Number of Shootings (per precinct)",
       title="Avg. Number of Shootings, Cure vs. post-2019 Precincts",
       color="") +
  scale_color_manual(values=c('red','blue'),labels=c("post-2019", 'Cure'))+
  theme(plot.title = element_text(size=16, face='bold',hjust=0.5))

#Plot avg shootings by year for early, mid, late Cure precincts
temp1 <- shootings_cure %>% filter(earlyCure) %>% group_by(year) %>% summarise(numShootings = mean(numShootings))
temp2 <- shootings_cure %>% filter(midCure) %>% group_by(year) %>% summarise(numShootings = mean(numShootings))
temp3 <- shootings_cure %>% filter(lateCure) %>% group_by(year) %>% summarise(numShootings = mean(numShootings))
plt <- ggplot() +
  geom_point(data=temp1, aes(x=year, y=numShootings,color='<2015'), size=2) +
  geom_line(data=temp1, aes(x=year, y=numShootings),color='red')+
  geom_point(data=temp2, aes(x=year, y=numShootings,color='2015-16'), size=2) +
  geom_line(data=temp2, aes(x=year, y=numShootings),color='blue')+
  geom_point(data=temp3, aes(x=year, y=numShootings,color='2019'), size=2) +
  geom_line(data=temp3, aes(x=year, y=numShootings),color='darkgreen')+
  labs(x="Year", y="Number of Shootings (per precinct)",color='') +
  scale_color_manual(values=c('red','blue','darkgreen'),labels=c("<2015", '2015-16','2019'))+
  theme(legend.position='bottom')
ggsave(file.path(figPth,"numShootings_byEarlyMidLate.pdf"), plt, width=5, height=4, units="in")
  
#Plot average number of shootings (precinct level) by year for control precincts, those
#touching vs. not touching any Cure precincts
temp <- shootings_cure %>% filter(!curePrecinct) %>% 
  group_by(controlSO, year) %>% summarise(numShootings = mean(numShootings))
plt <- ggplot(data=temp, aes(x=year, y=numShootings, color=controlSO)) +
  geom_point(size=2) +
  geom_line()+
  ylim(0,20)+
  labs(x="Year", y="Number of Shootings (per precinct)",
       color="") +
  scale_color_manual(values=c('red','blue'),labels=c("Non-Spillover", 'Spillover'))+
  theme(legend.position='bottom')
ggsave(file.path(figPth,"numShootings_byControlSO.pdf"), plt, width=5, height=4, units="in")

#For Cure precincts, plot true and counterfactual (predicted) num. of shootings
#get Cure precinct counterfactual
model2 <- lm(numShootings ~ factor(precinct) + factor(year) + lag6 + lag5 + lag4 +
              lag3 + lag2 + lag0 + lead1 + lead2 + lead3, data=df_analysis)
# model2 <- lm(numShootings ~ factor(precinct) + factor(year) + lagSO6 + lagSO5 + lagSO4 +
#               lagSO3 + lagSO2 + lagSO0 + leadSO1 + leadSO2 + leadSO3, data=df_analysis)
#zero out Cure treatment effects
model2$coefficients[93:101] = 0
#make predictions
predictions <- predict(model2, newdata=df_analysis, interval='confidence', level=0.95)
temp <- cbind(df_analysis, predictions)
temp <- temp %>% filter(curePrecinct) %>% group_by(year) %>% 
  summarise(numShootings = mean(numShootings), predicted=mean(fit),
            lwr = mean(lwr), upr=mean(upr))

plt <- ggplot(data=temp) +
  geom_point(aes(x=year, y=numShootings), size=2) +
  geom_point(aes(x=year, y=predicted), size=2) +
  geom_line(aes(x=year, y=numShootings, color='Cure'))+
  geom_line(aes(x=year, y=predicted, color='Counterfactual'))+
  geom_ribbon(aes(x = year, ymin=lwr, ymax=upr), fill="lightblue", alpha=0.3)+
  #ylim(15,70)+
  labs(x="Year", y="Number of Shootings (per precinct)",
       color="") +
  theme(legend.position='bottom')
ggsave(file.path(figPth,"numShootings_cureCntrFctl.pdf"), plt, width=5, height=4, units="in")
  
#Alternatively, filter out data for cure/spillover precincts after they've been 
  #exposed to Cure (possibly via spillover)
temp <- df_analysis %>% 
  filter(!((curePrecinct | controlSO) & (cureOn | spilloverOn)))
#Just estimate the precinct and year FEs. Year FEs for later years are now
#being solely estimated by pure control precincts. Precinct FEs are being estimated
#using data from years prior to any Cure exposure
modelFE <- lm(numShootings ~ factor(precinct) + factor(year), data=temp)
predictions <- predict(modelFE, newdata=df_analysis, interval='confidence', level=0.95)
#RUN appropriate code above to create plot from this

#Aside: use this model to residualize out FEs from full data
# temp <- cbind(df_analysis, predictions)
# temp <- temp %>% mutate(numShootingsResid = numShootings-fit)
# 
# ggplot(data=(temp %>% filter(curePrecinct)), aes(x=numShootingsResid)) + geom_histogram(binwidth=5, color="white", fill="blue")
# ggplot(data=(temp %>% filter(!curePrecinct)), aes(x=numShootingsResid)) + geom_histogram(binwidth=5, color="white", fill="blue")
# 
# #Try to decompose treatment into a Cure and spillover effect
# #Note that the SEs won't be right, b/c we need to correct for the fact that
# #numShootingsResid is predicted from a previous regression
# modelSO <- lm(numShootingsResid ~ cureOn + spilloverOn + cureOn:spilloverOn, data=temp)
# summary(modelSO)
```
